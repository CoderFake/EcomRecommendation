<!DOCTYPE html>
{% load static %}

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Ekka</title>
    <meta name="keywords" content="apparel, catalog, clean, ecommerce, ecommerce HTML, electronics, fashion, html eCommerce, html store, minimal, multipurpose, multipurpose ecommerce, online store, responsive ecommerce template, shops"/>
    <meta name="description" content="EKKA: Your One-Stop Shop for Everything">
    <!-- site Favicon -->
    <link rel="icon" href="{% static 'webapp/assets/images/favicon/favicon-8.png' %}" sizes="32x32" />
    <link rel="apple-touch-icon" href="{% static 'webapp/assets/images/favicon/favicon-8.png' %}" />
    <meta name="msapplication-TileImage" content="{% static 'webapp/assets/images/favicon/favicon.png' %}" />
    
    <!-- css Icon Font -->
    <link rel="stylesheet" href="{% static 'webapp/assets/css/vendor/ecicons.min.css' %}"/>
    <link href='https://fonts.googleapis.com/css?family=Nunito' rel='stylesheet'>
    
    <!-- css All Plugins Files -->
    <link rel="stylesheet" href="{% static 'webapp/assets/css/plugins/magnific-popup.css' %}" />
    <link rel="stylesheet" href="{% static 'webapp/assets/css/plugins/animate.css' %}"/>
    <link rel="stylesheet" href="{% static 'webapp/assets/css/plugins/swiper-bundle.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'webapp/assets/css/plugins/jquery-ui.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'webapp/assets/css/plugins/countdownTimer.css' %}"/>
    <link rel="stylesheet" href="{% static 'webapp/assets/css/plugins/slick.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'webapp/assets/css/plugins/nouislider.css' %}"/>
    <link rel="stylesheet" href="{% static 'webapp/assets/css/plugins/bootstrap.css' %}"/>

    <link rel="stylesheet" id="bg-switcher-css" href="{% static 'webapp/assets/css/backgrounds/bg-4.css' %}">
    <link rel="stylesheet" href="{% static 'webapp/assets/css/style.css' %}"/>
    <link rel="stylesheet" href="{% static 'webapp/assets/css/responsive.css' %}"/>

    <!-- Chat Widget Style -->
    <link rel="stylesheet" href="{% static 'webapp/assets/css/chat-widget.css' %}" />

    {% block extra_head %}

    {% endblock %}
    <style>
        body {
            font-family: 'Nunito';
        }
        
        /* Chat widget styles */
        .chat-widget-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .chat-widget-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #ff919c;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .chat-widget-button:hover {
            background-color: #ff919c;
            transform: scale(1.05);
        }
        
        .chat-widget-icon {
            color: white;
            font-size: 24px;
        }
        
        .chat-widget-popup {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 350px;
            height: 450px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: none;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .chat-widget-header {
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-widget-header h4 {
            margin: 0;
            font-size: 16px;
        }
        
        .chat-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        
        .chat-widget-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .chat-widget-input-area {
            padding: 10px;
            border-top: 1px solid #eee;
            display: flex;
        }
        
        .chat-widget-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        .chat-widget-send-btn {
            background-color: #ff919c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .chat-widget-message {
            max-width: 85%;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 15px;
            word-break: break-word;
        }
        
        .chat-widget-message.user {
            align-self: flex-end;
            background-color: #ff919c;
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .chat-widget-message.bot {
            align-self: flex-start;
            background-color: #f0f2f5;
            color: #333;
            border-bottom-left-radius: 5px;
        }
        
        .chat-widget-open .chat-widget-popup {
            display: flex;
        }
        
        .chat-widget-loading {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: #f0f2f5;
            border-radius: 15px;
            align-self: flex-start;
            margin-bottom: 8px;
        }
        
        .chat-widget-loading span {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: #888;
            border-radius: 50%;
            display: inline-block;
            animation: chat-loading 1.4s infinite ease-in-out both;
        }
        
        .chat-widget-loading span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .chat-widget-loading span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes chat-loading {
            0%, 80%, 100% { 
                transform: scale(0);
            } 
            40% { 
                transform: scale(1.0);
            }
        }
    </style>

</head>
<body style="font-family: 'Nunito';">

{% include 'includes/navbar.html' %}
    {% if request.user.is_authenticated %}
        <!-- Ekka Cart Start -->
        <div class="ec-side-cart-overlay"></div>
        <div id="ec-side-cart" class="ec-side-cart">
            <div class="ec-cart-inner">
                <div class="ec-cart-top">
                    <div class="ec-cart-title">
                        <span class="cart_title">My Cart</span>
                        <button class=" rounded-3 ec-close">x</button>
                    </div>
                    <ul class="eccart-pro-items">
                        <li>
                            <a href="product-left-sidebar.html" class="sidecart_pro_img"><img
                                    src="{% static 'webapp/assets/images/product-image/93_1.jpg' %}" alt="product"></a>
                            <div class="ec-pro-content">
                                <a href="single-product-left-sidebar.html" class="cart_pro_title">Mens Winter Leathers
                                    Jackets</a>
                                <span class="cart-price"><span>49$</span> x 1</span>
                                <div class="qty-plus-minus">
                                    <input class="qty-input" type="text" name="ec_qtybtn" value="1"/>
                                </div>
                                <a href="#" class="remove">x</a>
                            </div>
                        </li>
                        <li>
                            <a href="product-left-sidebar.html" class="sidecart_pro_img"><img
                                    src="{% static 'webapp/assets/images/product-image/96_1.jpg' %}" alt="product"></a>
                            <div class="ec-pro-content">
                                <a href="product-left-sidebar.html" class="cart_pro_title">Running & Trekking Shoes -
                                    White</a>
                                <span class="cart-price"><span>150$</span> x 1</span>
                                <div class="qty-plus-minus">
                                    <input class="qty-input" type="text" name="ec_qtybtn" value="1"/>
                                </div>
                                <a href="#" class="remove">x</a>
                            </div>
                        </li>
                        <li>
                            <a href="product-left-sidebar.html" class="sidecart_pro_img"><img
                                    src="{% static 'webapp/assets/images/product-image/111_1.jpg' %}" alt="product"></a>
                            <div class="ec-pro-content">
                                <a href="product-left-sidebar.html" class="cart_pro_title">Rose Gold Peacock Earrings</a>
                                <span class="cart-price"><span>950$</span> x 1</span>
                                <div class="qty-plus-minus">
                                    <input class="qty-input" type="text" name="ec_qtybtn" value="1"/>
                                </div>
                                <a href="#" class="remove">x</a>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="ec-cart-bottom">
                    <div class="cart-sub-total">
                        <table class="table cart-table">
                            <tbody>
                            <tr>
                                <td class="text-left">Sub-Total :</td>
                                <td class="text-right">300$</td>
                            </tr>
                            <tr>
                                <td class="text-left">VAT (20%) :</td>
                                <td class="text-right">60$</td>
                            </tr>
                            <tr>
                                <td class="text-left">Total :</td>
                                <td class="text-right primary-color">360$</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="cart_btn">
                        <a href="cart.html" class="btn btn-primary rounded-3">View Cart</a>
                        <a href="checkout.html" class="btn  btn-secondary rounded-3 ">Checkout</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- Ekka Cart End -->
    {% endif %}
{% block content %}


{% endblock %}
  <!-- Footer navigation panel for responsive display -->
{% include 'includes/footer.html' %}
   <!-- Feature tools end -->
   <div class="ec-nav-toolbar">
       <div class="container">
           <div class="ec-nav-panel">
               <div class="ec-nav-panel-icons">
                   <a href="#ec-mobile-menu" class="navbar-toggler-btn ec-header-btn ec-side-toggle"><img
                           src="{% static 'webapp/assets/images/icons/menu.svg' %}" class="svg_img header_svg" alt="" /></a>
               </div>
               <div class="ec-nav-panel-icons">
                   <a href="{% url 'cart' %}" class="ec-header-btn"><img
                           src="{% static 'webapp/assets/images/icons/cart.svg' %}" class="svg_img header_svg" alt="" /><span
                           class="ec-cart-noti ec-header-count cart-count-lable">{{cart_count}}</span></a>
               </div>
               <div class="ec-nav-panel-icons">
                   <a href="{% url 'index' %}" class="ec-header-btn"><img src="{% static 'webapp/assets/images/icons/home.svg' %}"
                           class="svg_img header_svg" alt="icon" /></a>
               </div>
               <div class="ec-nav-panel-icons">
                   <a href="{% url 'wishlist' %}" class="ec-header-btn"><img src="{% static 'webapp/assets/images/icons/wishlist.svg' %}"
                           class="svg_img header_svg" alt="icon" /><span class="ec-cart-noti wishlist-count">{% if request.user.is_authenticated %}{{ request.user.wishlist_set.count }}{% else %}0{% endif %}</span></a>
               </div>
               <div class="ec-nav-panel-icons">
{#                <a href="{% url 'login' %}" class="ec-header-btn"><img src="{% static 'webapp/assets/images/icons/user.svg' %}"#}
{#                           class="svg_img header_svg" alt="icon" /></a>#}
                   <div class="ec-header-user dropup">
                       <button class=" rounded-3 dropdown-toggle" data-bs-toggle="dropdown"><img
                               src="{% static 'webapp/assets/images/icons/user.svg' %}" class="svg_img header_svg"
                               alt=""/></button>
                       <ul class="dropdown-menu dropdown-menu-right">
                           {% if user.is_authenticated %}
                               <li><a class="dropdown-item" href="{% url 'edit_profile' %}">
                                   {% if not user.full_name  and request.user.is_admin %}
                                       Hello, ADMIN</a>
                                   {% else %}
                                       {{ user.full_name }}
                                   {% endif %}
                               </li>
                               <li><a class="dropdown-item" href={% url 'changePassword' %}>Change Password</a></li>
                               <li><a class="dropdown-item" href={% url 'logout' %}>Logout</a></li>
                               {% if request.user and request.user.is_admin %}
                                   <li><a class="dropdown-item" href={% url 'admin_dashboard' %}>Admin Panel</a></li>
                               {% endif %}
                           {% else %}
                               <li><a class="dropdown-item" href={% url 'register' %}>Register</a></li>
                               <li><a class="dropdown-item" href={% url 'login' %}>Login</a></li>
                           {% endif %}

                       </ul>
                   </div>
               </div>

           </div>
       </div>
   </div>
   <!-- Footer navigation panel for responsive display end -->


   <!-- Cart Floating Button -->
   <div class="ec-cart-float">
       <a href="{% url 'cart' %}" class="ec-header-btn">
           <div class="header-icon"><img src="{% static 'webapp/assets/images/icons/cart.svg' %}" class="svg_img header_svg" alt="" /></div>
           <span class="ec-cart-count cart-count-lable">{{cart_count}}</span>
       </a>
   </div>
<!-- Cart Floating Button end -->

<!-- Vendor JS -->
<script src="{% static 'webapp/assets/js/vendor/jquery-3.5.1.min.js' %}"></script>
<script src="{% static 'webapp/assets/js/vendor/popper.min.js' %}"></script>
<script src="{% static 'webapp/assets/js/vendor/bootstrap.min.js' %}"></script>
<script src="{% static 'webapp/assets/js/vendor/jquery-migrate-3.3.0.min.js' %}"></script>
<script src="{% static 'webapp/assets/js/vendor/modernizr-3.11.2.min.js' %}"></script>

<!--Plugins JS-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>
<script src="{% static 'webapp/assets/js/plugins/jquery.sticky-sidebar.js' %}"></script>
<script src="{% static 'webapp/assets/js/plugins/swiper-bundle.min.js' %}"></script>
<script src="{% static 'webapp/assets/js/plugins/countdownTimer.min.js' %}"></script>
<script src="{% static 'webapp/assets/js/plugins/nouislider.js' %}"></script>
<script src="{% static 'webapp/assets/js/plugins/scrollup.js' %}"></script>
<script src="{% static 'webapp/assets/js/plugins/jquery.zoom.min.js' %}"></script>
<script src="{% static 'webapp/assets/js/plugins/slick.min.js' %}"></script>
<script src="{% static 'webapp/assets/js/plugins/owl.carousel.min.js' %}"></script>
<script src="{% static 'webapp/assets/js/plugins/infiniteslidev2.js' %}"></script>
<script src="{% static 'webapp/assets/js/plugins/click-to-call.js' %}"></script>
<script src="{% static 'webapp/assets/swiper/swiper-bundle.min.js' %}"></script><script>
    function googleTranslateElementInit() {
        new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element');
    }
</script>
<script>
    $(document).ready(function () {
        $('.product-session').click(function (e) {
            e.preventDefault();
            var hrefValue = $(this).attr("href");
            var urlArray = hrefValue.split("/");
            var ProductSlug = urlArray[urlArray.length - 1];
            console.log(ProductSlug);
            $.ajax({
                type: "POST",
                headers: {
                    'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                },
                url: "{% url 'product_session' %}",
                data: {'product_slug': ProductSlug},
                success: function(response) {
                },
                error: function(error) {
                    console.error('Ajax request failed:', error);
                }
            });
            window.location.href = hrefValue;
        })
    })
</script>

<!-- Chat Widget -->
<div class="chat-widget-container">
    <div class="chat-widget-button" id="chat-widget-toggle">
        <img src="{% static 'webapp/assets/images/icons/chat-bot.png' %}" alt="Chatbot" width="28" height="28" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);" />
    </div>
    <div class="chat-widget-popup">
        <div class="chat-widget-header">
            <h4><img src="{% static 'webapp/assets/images/icons/chat-bot.png' %}" alt="Chatbot" width="24" height="24" style="margin-right: 8px;" />EKKA</h4>
            <div>
                <button class="chat-new-btn btn btn-outline-primary" id="chat-widget-new" title="New chat">New chat</button>
                <button class="chat-close-btn text-danger" id="chat-widget-close">&times;</button>
            </div>
        </div>
        <div class="chat-widget-messages" id="chat-widget-messages">
        </div>
        <div class="chat-widget-input-container">
            <input type="text" class="chat-widget-input" id="chat-widget-input" placeholder="Type a message..." />
            <button class="chat-widget-send-btn" id="chat-widget-send">
                <i class="ec ec-arrow-right"></i>
            </button>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Chat widget variables
        const $chatContainer = $('.chat-widget-container');
        const $chatToggle = $('#chat-widget-toggle');
        const $chatClose = $('#chat-widget-close');
        const $chatNew = $('#chat-widget-new');
        const $chatInput = $('#chat-widget-input');
        const $chatSend = $('#chat-widget-send');
        const $chatMessages = $('#chat-widget-messages');

        let chatId = localStorage.getItem('chatWidgetId');

        let isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
        let lastAuthStatus = isAuthenticated;
        
        function checkAuthStatus() {
            $.ajax({
                url: '/chatbot/check_auth',
                type: 'GET',
                success: function(response) {
                    const newAuthStatus = response.is_authenticated;

                    if (newAuthStatus !== lastAuthStatus) {
                        lastAuthStatus = newAuthStatus;
                        
                        if (!newAuthStatus) {
                            createNewChat();
                        } else if (chatId) {
                            $.ajax({
                                url: '/chatbot/update_session',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    chat_id: chatId
                                })
                            });
                        }
                    }
                }
            });
        }
        setInterval(checkAuthStatus, 30000);
        
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
            $chatContainer.addClass('mobile-device');
            
            $chatInput.on('focus', function() {
                setTimeout(function() {
                    scrollToBottom();
                }, 300);
            });
        }
        
        function loadInitialMessage() {
            $.ajax({
                url: '/chatbot/get_initial_message',
                type: 'GET',
                success: function(response) {
                    $chatMessages.empty();
                    addMessage(response.message, 'bot');
                    chatId = response.chat_id;
                    localStorage.setItem('chatWidgetId', chatId);
                },
                error: function() {
                    const message = "Hello! I'm EKKA, your shopping assistant. How can I help you today?";
                    $chatMessages.empty();
                    addMessage(message, 'bot');
                }
            });
        }
        
        function createNewChat() {
            localStorage.removeItem('chatWidgetId');
            chatId = null;
            
            $.ajax({
                url: '/chatbot/new_chat',
                type: 'GET',
                success: function(response) {
                    $chatMessages.empty();
                    addMessage(response.message, 'bot');
                    chatId = response.chat_id;
                    localStorage.setItem('chatWidgetId', chatId);
                },
                error: function() {
                    const message = "Hello! I'm EKKA, your shopping assistant. How can I help you today?";
                    $chatMessages.empty();
                    addMessage(message, 'bot');
                }
            });
        }
        
        function loadChatHistory() {
            if (!chatId) {
                loadInitialMessage();
                return;
            }
            
            $.ajax({
                url: '/chatbot/history/' + chatId,
                type: 'GET',
                success: function(response) {
                    $chatMessages.empty();
                    
                    if (response.messages && response.messages.length > 0) {
                        response.messages.forEach(msg => {
                            addMessage(msg.content, msg.sender);
                        });
                        
                        scrollToBottom();
                    } else {
                        loadInitialMessage();
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 404) {
                        createNewChat();
                    } else {
                        loadInitialMessage();
                    }
                }
            });
        }
        
        function toggleChat() {
            $chatContainer.toggleClass('chat-widget-open');
            if ($chatContainer.hasClass('chat-widget-open')) {
                $chatInput.focus();
                
                checkAuthStatus();
                
                if ($chatMessages.children().length === 0) {
                    loadChatHistory();
                }
            }
        }
        
        if (isMobile) {
            $chatToggle.on('touchend', function(e) {
                e.preventDefault();
                toggleChat();
            });
            
            $chatClose.on('touchend', function(e) {
                e.preventDefault();
                $chatContainer.removeClass('chat-widget-open');
            });
            
            $chatNew.on('touchend', function(e) {
                e.preventDefault();
                createNewChat();
            });
            
            $chatSend.on('touchend', function(e) {
                e.preventDefault();
                sendMessage();
            });
        } else {
            $chatToggle.on('click', toggleChat);
            $chatClose.on('click', function() {
                $chatContainer.removeClass('chat-widget-open');
            });
            $chatNew.on('click', createNewChat);
            $chatSend.on('click', sendMessage);
        }
        
        $chatInput.on('keypress', function(e) {
            if (e.which === 13) {
                sendMessage();
                return false;
            }
        });
        
        function sendMessage() {
            const message = $chatInput.val().trim();
            if (!message) return;
            
            addMessage(message, 'user');
            $chatInput.val('').focus();
            
            const $loading = $('<div class="chat-widget-loading"><span></span><span></span><span></span></div>');
            $chatMessages.append($loading);
            scrollToBottom();
            
            $.ajax({
                url: '/chatbot/generate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    query: message,
                    chat_id: chatId
                }),
                success: function(response) {
                    $loading.remove();
                    addMessage(response.response, 'bot');
                    
                    if (response.chat_id) {
                        chatId = response.chat_id;
                        localStorage.setItem('chatWidgetId', chatId);
                    }
                    
                    scrollToBottom();
                },
                error: function(xhr, status, error) {
                    $loading.remove();
                    let errorMsg = 'Sorry, an error occurred while processing your request. Please try again later.';
                    addMessage(errorMsg, 'bot');
                    console.error('Chat error:', error);
                    
                    scrollToBottom();
                }
            });
        }
        
        function addMessage(text, type) {
            const $message = $('<div class="chat-widget-message"></div>').addClass(type).text(text);
            $chatMessages.append($message);
            scrollToBottom();
        }
        
        function scrollToBottom() {
            $chatMessages.scrollTop($chatMessages[0].scrollHeight);
        }
    });
</script>

<!-- Main Js -->
<script src="{% static 'webapp/assets/js/vendor/index.js' %}"></script>
<script src="{% static 'webapp/assets/js/main.js' %}"></script>


{% block jsblock %}
{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Swiper !== 'undefined') {
            const checkAndInitSwiper = function(selector, options) {
                const elements = document.querySelectorAll(selector);
                if (elements.length > 0) {
                    elements.forEach(function(element) {
                        if (!element.swiper) {
                            try {
                                new Swiper(element, options || {});
                            } catch (error) {
                                console.error('Lỗi khởi tạo Swiper:', error);
                            }
                        }
                    });
                }
            };

            setTimeout(function() {
                checkAndInitSwiper('.ec-slider.swiper-container', {
                    loop: true,
                    speed: 2000,
                    effect: 'slide',
                    autoplay: {
                        delay: 7000,
                        disableOnInteraction: false
                    },
                    pagination: {
                        el: '.swiper-pagination',
                        clickable: true
                    },
                    navigation: {
                        nextEl: '.swiper-button-next',
                        prevEl: '.swiper-button-prev'
                    }
                });

                checkAndInitSwiper('.single-product-slider', {
                    slidesPerView: 4,
                    spaceBetween: 20,
                    speed: 1500,
                    loop: true,
                    navigation: {
                        nextEl: '.swiper-button-next',
                        prevEl: '.swiper-button-prev'
                    },
                    breakpoints: {
                        0: { slidesPerView: 1 },
                        478: { slidesPerView: 1 },
                        576: { slidesPerView: 2 },
                        768: { slidesPerView: 3 },
                        992: { slidesPerView: 3 },
                        1024: { slidesPerView: 4 },
                        1200: { slidesPerView: 4 }
                    }
                });
            }, 500);
        }
    });
</script>
</body>
</html>
